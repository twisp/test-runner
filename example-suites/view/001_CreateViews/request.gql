mutation CreateViews {
  avgSettled: schema {
    createView(
      input: {
        # A name for the aggregation
        name: "avgSettled"
        description: "average settled entries"
        sources: [{ entity: Entry, triggers: [OnInsert] }]
        normalize: "[context.trigger.new.account_id] + context.trigger.new.parent_account_ids"
        document: [
          { alias: "account_id", value: "context.trigger.normalize", type: UUID }
          { alias: "count", value: "document.count + uint(1)", type: UInt }
          { alias: "currency", value: "context.trigger.new.amount.currency()", type: String }
          {
            alias: "avg"
            value: """
            decimal.Round(
              decimal.Quo(
                (decimal.Mul(document.avg, decimal(string(document.count))) + context.trigger.new.amount.decimal()),
                decimal(string(this.count)),
                uint(39)),
              "half_even",
              2
            )
            """
            type: Decimal
          }
          { alias: "journal_id", value: "context.trigger.new.journal_id", type: UUID }
        ]
        # The schema that this aggregation will track
        partition: [{ alias: "account_id", value: "document.account_id" }]
        sort: [{ alias: "currency", value: "document.currency", sort: ASC }]
        filters: { settledOnly: "context.trigger.new.layer == SETTLED" }
        config: { enableConcurrentPosting: false }
      }
    ) {
      document {
        alias
        value
        type
      }
    }
  }
  perPolicyId: schema {
    createView(
      input: {
        # A name for the aggregation
        name: "perPolicyId"
        description: "layered balances by policy id"
        sources: [{ entity: Entry, triggers: [OnInsert] }]
        normalize: "[context.trigger.new.account_id] + context.trigger.new.parent_account_ids"
        document: [
          { alias: "account_id", value: "context.trigger.normalize", type: UUID }
          { alias: "policyId", value: "context.trigger.new.metadata.policyId", type: String }
          { alias: "currency", value: "context.trigger.new.amount.currency()", type: String }
          {
            alias: "pending"
            value: """
            context.trigger.new.layer == PENDING ? (context.trigger.new.direction == DEBIT ? document.pending - context.trigger.new.amount.decimal() : document.pending + context.trigger.new.amount.decimal()) : document.pending
            """
            type: Decimal
          }
          {
            alias: "encumbrance"
            value: """
            context.trigger.new.layer == ENCUMBRANCE ? (context.trigger.new.direction == DEBIT ? document.encumbrance - context.trigger.new.amount.decimal() : document.encumbrance + context.trigger.new.amount.decimal()) : document.encumbrance
            """
            type: Decimal
          }
          {
            alias: "settled"
            value: """
            context.trigger.new.layer == SETTLED ? (context.trigger.new.direction == DEBIT ? document.settled - context.trigger.new.amount.decimal() : document.settled + context.trigger.new.amount.decimal()) : document.settled
            """
            type: Decimal
          }
        ]
        # The schema that this aggregation will track
        partition: [{ alias: "policyId", value: "document.policyId" }]
        sort: [
          { alias: "account_id", value: "document.account_id", sort: ASC }
          { alias: "currency", value: "document.currency", sort: ASC }
        ]
        filters: {
          hasPolicyId: "has(context.trigger.new.metadata) && has(context.trigger.new.metadata.policyId)"
        }
        config: { enableConcurrentPosting: false }
      }
    ) {
      document {
        alias
        value
        type
      }
    }
  }
}
